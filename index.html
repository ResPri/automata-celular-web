<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autómata Celular</title>
    <style>
        /* Estilos generales de la página */
        html, body {
            height: 100%; /* Asegura que html y body ocupen el 100% de la altura de la ventana */
            margin: 0;
            padding: 0;
        }

        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            display: flex; /* Convierte el body en un contenedor flexbox */
            flex-direction: column; /* Apila los elementos hijos verticalmente */
            align-items: center;
            min-height: 100vh; /* Asegura que el body ocupe al menos el 100% de la altura de la ventana */
        }
        header {
            background-color: #4c4c4c;
            color: white;
            padding: 1em;
            text-align: center;
            width: 100%;
            flex-shrink: 0; /* Evita que el encabezado se encoja */
        }
        header h1 {
            color: #0575ff;
            margin: 0;
        }
        main {
            display: flex;
            flex-direction: column; /* Mantenemos la columna para que el contenido se apile verticalmente */
            align-items: center;
            padding: 20px;
            width: 90%; /* Ancho de la sección principal */
            max-width: 1000px; /* Ancho máximo para la sección principal */
            box-sizing: border-box;
            flex-grow: 1; /* Permite que la sección principal crezca y ocupe el espacio disponible */
            flex-shrink: 1; /* Permite que la sección principal se encoja si es necesario */
        }
        /* Estilos para el contenedor del juego */
        #juego-container {
            width: 80%; /* Ocupa el 80% del ancho del padre (main) */
            margin: 30px auto; /* 30px arriba/abajo, auto para centrado horizontal (10% a cada lado) */
            border: 1px solid #ccc;
            background-color: #000; /* Fondo negro para que las barras sean negras si aparecen */
            
            /* Centra el canvas dentro de este contenedor */
            display: flex;
            justify-content: center;
            align-items: center;
            
            /* ¡IMPORTANT! Esta relación (16/9) debe coincidir con la de tu juego en Godot (1152x648 es 16:9) */
            aspect-ratio: 16 / 9; 
        }

        /* El selector CSS ahora apunta al ID correcto del canvas */
        #canvas {
            display: block; /* Asegura que sea un elemento de bloque */
            width: 100%; /* Ocupa el 100% del ancho de su contenedor */
            height: 100%; /* Ocupa el 100% de la altura de su contenedor */
        }

        #tabla-records {
            width: 100%;
            border: 1px solid #ccc;
            padding: 1em;
            background-color: #fff;
            box-sizing: border-box;
            margin-bottom: 20px;
        }
        #tabla-records h2 {
            text-align: center;
            margin-bottom: 0.5em;
        }
        #tabla-records ol {
            padding-left: 2em;
            list-style-position: inside;
        }
        #tabla-records li {
            padding: 0.5em 0;
            border-bottom: 1px solid #eee;
        }
        #tabla-records li:last-child {
            border-bottom: none;
        }
        footer {
            background-color: #333;
            color: white;
            padding: 1em;
            text-align: center;
            width: 100%;
            flex-shrink: 0; /* Evita que el pie de página se encoja */
            margin-top: auto; /* Empuja el pie de página hacia abajo si hay espacio disponible */
            font-size: 0.9em; /* Ajuste de tamaño de fuente para el footer */
        }
        footer p {
            margin: 0.5em 0;
        }
        footer a {
            color: #0575ff;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        @media (min-width: 768px) {
            main {
                flex-direction: column; /* Mantenemos la columna para pantallas más grandes para que el juego y la tabla estén apilados */
                align-items: stretch;
            }
            #tabla-records {
                width: 100%;
            }
        }
        #cargar-mas {
            display: inline-block;
            margin: 1em 0.5em;
            padding: 0.5em 1em;
            background-color: #0575ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            vertical-align: top;
        }
        #cargar-mas:hover {
            background-color: #0450b3;
        }
        #cargar-mas:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #plegar-lista {
            display: inline-block;
            margin: 1em 0.5em;
            padding: 0.5em 1em;
            background-color: #0575ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            vertical-align: top;
            display: none;
        }
        #plegar-lista:hover {
            background-color: #0450b3;
        }
        #introduccion-automata-celular {
            margin-bottom: 20px;
            padding: 1em;
            background-color: #e9e9e9;
            border-radius: 5px;
            text-align: justify;
            width: 100%;
        }

        /* Estilos para el contenedor del vídeo de YouTube */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* Relación de aspecto 16:9 (altura / ancho = 9 / 16 = 0.5625) */
            height: 0;
            overflow: hidden;
            margin-bottom: 20px; /* Espacio debajo del vídeo */
            background-color: #000; /* Fondo negro para el reproductor */
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Autómata Celular 1.13</h1>
    </header>
    <main>
        <div id="introduccion-automata-celular">
            <h2>¡Desafío Autómata Celular!</h2>
            <p>Exploraremos cómo reglas simples generan comportamientos complejos en una cuadrícula de celdas. Aunque las reglas pueden ser sencillas, surgen patrones sorprendentes. El autómata celular nos permite comprender cómo la complejidad emerge de la simplicidad. Experimenta en tiempo real, descubre patrones ocultos y observa la evolución de las pautas. ¿Podrás encontrar la secuencia que maximiza la puntuación? ¡Demuestra tu habilidad! Compite por las mejores puntuaciones y domina la tabla de récords. ¿Serás el mejor estratega celular? ¡Prepárate para descubrir la belleza de la computación creativa y el desafío de dominar el autómata celular!</p>
        </div>
        
        <div id="juego-container">
            <canvas id="canvas"></canvas>
        </div>

        <div style="width: 90%; max-width: 800px; margin: 20px auto; text-align: center;">
            <h2>El Viaje de Desarrollo: IA y Humano Juntos</h2>
            <p>Descubre la fascinante historia detrás de la creación de este juego, una colaboración única entre un desarrollador y una Inteligencia Artificial. Este proyecto es un testimonio de cómo la creatividad humana y la capacidad de generación de la IA pueden unirse para dar vida a ideas complejas, incluso sin conocimientos previos de programación. Exploramos juntos los desafíos técnicos, depuramos el código, y aprendimos a comunicarnos de manera efectiva para transformar una visión en una experiencia interactiva. ¡No te pierdas el vídeo que lo explica todo!</p>
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/VIDEO_ID_DE_YOUTUBE" 
                        title="YouTube video player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        referrerpolicy="strict-origin-when-cross-origin" 
                        allowfullscreen>
                </iframe>
            </div>
            <p>¿Te ha picado la curiosidad? <a href="transcripcion.html" style="color: #0575ff;">Lee la transcripción completa de nuestra conversación aquí.</a></p>
            <p>¿Quieres saber cómo desarrollar un juego sin saber programar? <a href="transcripcion.html#guia-desarrollo-gemini" style="color: #0575ff;">Accede a la guía aquí.</a></p>
        </div>
        
        <div id="tabla-records">
            <h2>Récords</h2>
            <ol>
            </ol>
            <div style="text-align: center;">
                <button id="cargar-mas">Cargar más récords</button>
                <button id="plegar-lista">Plegar lista</button>
            </div>
        </div>
    </main>
    <footer>
        <p>© 2025 Autómata Celular. Todos los derechos reservados.</p>
        <p>Desarrollado por Respi con la ayuda de Gemini AI.</p>
        <p>Tecnología: Godot Engine</p>
        <p><a href="contacto.html">Contacto</a> | <a href="politica-privacidad.html">Política de Privacidad</a> | <a href="terminos-uso.html">Términos de Uso</a></p>
        </footer>
    <script src="Juego Godot/automatacelular.js"></script>
    <script>
        // --- Código para obtener y mostrar los récords ---
        const listaRecordsElement = document.querySelector("#tabla-records ol");
        const cargarMasButton = document.querySelector("#cargar-mas");
        const plegarListaButton = document.querySelector("#plegar-lista");
        let todosLosRecords = [];
        let cantidadMostrada = 0;
        const cantidadPorPagina = 10;
        
        // --- ¡IMPORTANTE! Actualizamos las URLs para que apunten a las funciones de Netlify ---
        // Netlify Functions se acceden a través de la ruta /.netlify/functions/nombre_de_la_funcion
        const highscoreUrlPost = '/.netlify/functions/save_highscore'; 
        const highscoreUrlGet = '/.netlify/functions/get_highscores';

        async function obtenerYMostrarRecords() {
            try {
                // --- ¡IMPORTANTE! Reemplazamos la simulación con una llamada real a la función de Netlify ---
                const response = await fetch(highscoreUrlGet); 
                
                if (!response.ok) {
                    throw new Error(`Error al obtener los récords: ${response.status}`);
                }
                const data = await response.json();

                if (data.status === "ok") {
                    todosLosRecords = data.highscores;
                    cantidadMostrada = 0;
                    listaRecordsElement.innerHTML = ''; // Limpia la lista
                    mostrarSiguientesRecords();

                } else {
                    console.error("Error del servidor:", data.message);
                    // Muestra un mensaje de error en la página
                    listaRecordsElement.innerHTML = `<li>Error al obtener los récords: ${data.message}</li>`;
                    cargarMasButton.style.display = 'none';

                }
            } catch (error) {
                console.error("Error:", error);
                listaRecordsElement.innerHTML = `<li>Error al obtener los récords: ${error.message}</li>`;
                cargarMasButton.style.display = 'none';
            }
        }

        function mostrarSiguientesRecords() {
            const siguientesRecords = todosLosRecords.slice(cantidadMostrada, cantidadMostrada + cantidadPorPagina);

            siguientesRecords.forEach(record => {
                // CORRECCIÓN: Usar 'name' y 'score' según la respuesta de la función de Netlify
                const nuevoItem = document.createElement('li');
                nuevoItem.textContent = `${record.name} - ${record.score}`;
                listaRecordsElement.appendChild(nuevoItem);
            });
            cantidadMostrada += cantidadPorPagina;

            if (cantidadMostrada >= todosLosRecords.length) {
                cargarMasButton.disabled = true;
            } else {
                cargarMasButton.disabled = false;
            }
            plegarListaButton.style.display = cantidadMostrada > 10 ? 'inline-block' : 'none';
        }

        function plegarListaRecords() {
            cantidadMostrada = 0;
            listaRecordsElement.innerHTML = '';
            mostrarSiguientesRecords();
            plegarListaButton.style.display = 'none';
        }

        function enviarRecord(nombre, puntuacion) {
            const data = {
                // CORRECCIÓN: Asegurarse de que el nombre del campo coincida con el backend
                name: nombre, 
                score: puntuacion // CORRECCIÓN: Asegurarse de que el nombre del campo coincida con el backend
            };
            fetch(highscoreUrlPost, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error al enviar el récord: ${response.status}`);
                }
                return response.json();
            })
            .then(responseData => {
                if (responseData.status === 'ok') {
                    console.log('Récord guardado exitosamente');
                    obtenerYMostrarRecords(); // Recargar la lista de récords
                } else {
                    console.error('Error al guardar el récord:', responseData.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Llama a esta función desde Godot después de que el juego termine
        // window.onGameOver = function(nombreJugador, puntuacion) { // No es necesario si Godot llama directamente a enviarRecord
        //     enviarRecord(nombreJugador, puntuacion);
        // }

        // Añade un listener para redimensionar el canvas cuando la ventana cambie de tamaño
        window.addEventListener('resize', () => {
            if (engineInstance && canvas) {
                // Asegura que el canvas se redimensiona al tamaño de su contenedor
                // y luego notifica a Godot para que ajuste su renderizado interno
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
                if (engineInstance.setCanvasSize) {
                    engineInstance.setCanvasSize(canvas.clientWidth, canvas.clientHeight);
                }
            }
        });

        // Única función window.onload para inicializar todo
        window.onload = function() {
            // Inicialización de Godot
            const canvas = document.getElementById('canvas');
            const GODOT_CONFIG = {
                args: [],
                canvas: canvas,
                canvasResizePolicy: 1, // 1 = SCALE (Godot escala el renderizado)
                ensureCrossOriginIsolationHeaders: true,
                executable: "Juego Godot/automatacelular",
                experimentalVK: false,
                fileSizes: {
                    "Juego Godot/automatacelular.pck": 1017119,
                    "Juego Godot/automatacelular.wasm": 43610726
                },
                focusCanvas: false,
                gdextensionLibs: [],
                width: 1152,
                height: 648
            };

            let engineInstance;

            new Engine(GODOT_CONFIG).startGame().then((instance) => {
                console.log("Juego Godot iniciado y ejecutándose.");
                engineInstance = instance;
                if (engineInstance && engineInstance.setCanvasSize) {
                    engineInstance.setCanvasSize(canvas.clientWidth, canvas.clientHeight);
                }
            }).catch((err) => {
                console.error("Error al iniciar el juego Godot:", err);
                const gameContainer = document.getElementById('juego-container');
                gameContainer.innerHTML = '<p style="color: red; text-align: center;">Error al cargar el juego. Por favor, revisa la consola para más detalles.</p>';
            });

            // Inicialización de los récords
            obtenerYMostrarRecords();
            cargarMasButton.addEventListener('click', mostrarSiguientesRecords);
            plegarListaButton.addEventListener('click', plegarListaRecords);
        };
    </script>
</body>
</html>




