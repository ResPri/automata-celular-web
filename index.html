<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autómata Celular</title>
    <style>
        /* Estilos generales de la página */
        html, body {
            height: 100%; /* Asegura que html y body ocupen el 100% de la altura de la ventana */
            margin: 0;
            padding: 0;
        }

        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            display: flex; /* Convierte el body en un contenedor flexbox */
            flex-direction: column; /* Apila los elementos hijos verticalmente */
            align-items: center;
            min-height: 100vh; /* Asegura que el body ocupe al menos el 100% de la altura de la ventana */
        }
        header {
            background-color: #4c4c4c;
            color: white;
            padding: 1em;
            text-align: center;
            width: 100%;
            flex-shrink: 0; /* Evita que el encabezado se encoja */
        }
        header h1 {
            color: #0575ff;
            margin: 0;
        }
        main {
            flex-grow: 1; /* Permite que el contenido principal ocupe el espacio disponible */
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .game-area {
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinea los elementos en la parte superior */
            gap: 20px; /* Espacio entre el juego y los récords */
            width: 100%;
            max-width: 1400px; /* Ancho máximo del área de juego y récords */
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
        }
        #juego-container {
            flex: 1 1 700px; /* El contenedor del juego ocupará al menos 700px de ancho */
            max-width: 1152px; /* Ancho máximo para el canvas de Godot */
            background-color: #333;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative; /* Para posicionar el canvas de Godot */
            aspect-ratio: 1152 / 648; /* Mantener la relación de aspecto del juego Godot */
            width: 100%; /* El ancho se ajusta al flex-basis y max-width */
        }
        #godot-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        .highscores-section {
            flex: 0 1 300px; /* La sección de récords tendrá un ancho fijo de 300px */
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: left;
            margin-top: 20px; /* Espacio superior para separar del encabezado */
        }
        .highscores-section h2 {
            color: #0575ff;
            text-align: center;
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        #highscores-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 300px; /* Altura máxima para la lista de récords */
            overflow-y: auto; /* Scroll si hay muchos récords */
        }
        #highscores-list li {
            padding: 8px 0;
            border-bottom: 1px dotted #eee;
            font-size: 0.95em;
            color: #333;
        }
        #highscores-list li:last-child {
            border-bottom: none;
        }
        .highscores-controls {
            text-align: center;
            margin-top: 15px;
        }
        .highscores-controls button {
            background-color: #0575ff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin: 5px;
            transition: background-color 0.3s ease;
        }
        .highscores-controls button:hover {
            background-color: #0056b3;
        }
        footer {
            margin-top: auto; /* Empuja el footer hacia abajo */
            background-color: #4c4c4c;
            color: white;
            padding: 1em;
            text-align: center;
            width: 100%;
            flex-shrink: 0; /* Evita que el pie de página se encoja */
        }
        footer a {
            color: #0575ff;
            text-decoration: none;
            margin: 0 10px;
        }
        footer a:hover {
            text-decoration: underline;
        }

        /* Media Queries para responsividad */
        @media (max-width: 900px) {
            .game-area {
                flex-direction: column;
                align-items: center;
            }
            .highscores-section {
                width: 90%; /* Ocupa casi todo el ancho disponible */
                max-width: 400px; /* Pero con un máximo para no ser demasiado ancho en pantallas grandes */
                margin-top: 30px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Autómata Celular3.2</h1>
        <nav>
            <a href="index.html">Jugar</a>
            <a href="contacto.html">Contacto</a>
            <a href="politica-privacidad.html">Política de Privacidad</a>
            <a href="terminos-uso.html">Términos de Uso</a>
        </nav>
    </header>

    <main>
        <div class="game-area">
            <div id="juego-container">
                <canvas id="godot-canvas"></canvas>
            </div>

            <div class="highscores-section">
                <h2>Tabla de Récords</h2>
                <ul id="highscores-list">
                    <li>Cargando récords...</li>
                </ul>
                <div class="highscores-controls">
                    <button id="cargarMasButton">Cargar más</button>
                    <button id="plegarListaButton">Plegar lista</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Autómata Celular. Todos los derechos reservados.</p>
        <a href="politica-privacidad.html">Política de Privacidad</a> | 
        <a href="terminos-uso.html">Términos de Uso</a> |
        <a href="contacto.html">Contacto</a>
    </footer>

    <script src="Juego Godot/godot.js"></script>

    <script>
        // URLs de tus Netlify Functions
        const GET_HIGHSCORES_URL = 'https://neon-granita-f29eda.netlify.app/.netlify/functions/get-highscores';
        const SAVE_HIGHSCORE_URL = 'https://neon-granita-f29eda.netlify.app/.netlify/functions/save-highscore';

        // --- Funciones para manejar los récords ---

        // Función para mostrar los récords en el HTML
        function displayHighscores(highscores) {
            const highscoresList = document.getElementById('highscores-list');
            if (!highscoresList) {
                console.error('Elemento con ID "highscores-list" no encontrado.');
                return;
            }
            highscoresList.innerHTML = ''; // Limpiar la lista actual

            if (highscores.length === 0) {
                highscoresList.innerHTML = '<li>No hay récords aún. ¡Sé el primero!</li>';
                return;
            }

            highscores.forEach((record, index) => {
                const listItem = document.createElement('li');
                // Formatear el nombre y la puntuación
                // Asegúrate de que 'score' es un número antes de usar toLocaleString para evitar errores.
                const scoreFormatted = typeof record.score === 'number' ? record.score.toLocaleString() : record.score;
                listItem.textContent = `${index + 1}. ${record.name}: ${scoreFormatted}`;
                highscoresList.appendChild(listItem);
            });
        }

        // Función para obtener récords de Netlify Function
        async function fetchHighscores() {
            try {
                const response = await fetch(GET_HIGHSCORES_URL);
                const data = await response.json();

                if (data.status === 'ok') {
                    console.log('Récords obtenidos:', data.highscores);
                    displayHighscores(data.highscores);
                } else {
                    console.error('Error al obtener récords del backend:', data.message);
                    displayHighscores([]); // Mostrar lista vacía o mensaje de error
                }
            } catch (error) {
                console.error('Error de red o del servidor al obtener récords:', error);
                displayHighscores([]); // Mostrar lista vacía o mensaje de error
            }
        }

        // Función para enviar un nuevo récord a Netlify Function
        // Esta función será llamada desde Godot. La exportamos para que Godot pueda acceder a ella.
        window.saveNewHighscore = async (name, score) => {
            try {
                const response = await fetch(SAVE_HIGHSCORE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, score })
                });
                const data = await response.json();

                if (data.status === 'ok') {
                    console.log('Récord guardado exitosamente:', data.message);
                    // Una vez guardado, volvemos a cargar los récords para actualizar la lista
                    await fetchHighscores();
                    return true; // Indicar a Godot que se guardó correctamente
                } else {
                    console.error('Error al guardar récord:', data.message);
                    return false; // Indicar a Godot que hubo un error
                }
            } catch (error) {
                console.error('Error de red o del servidor al guardar récord:', error);
                return false; // Indicar a Godot que hubo un error
            }
        };


        // --- Lógica de inicialización del juego Godot y los récords ---
        window.onload = function() {
            const canvas = document.getElementById('godot-canvas');
            const cargarMasButton = document.getElementById('cargarMasButton'); // Mantener si Godot controla esto
            const plegarListaButton = document.getElementById('plegarListaButton'); // Mantener si Godot controla esto

            const GODOT_CONFIG = {
                canvas: canvas,
                executable: "Juego Godot/automatacelular",
                experimentalVK: false,
                fileSizes: {
                    "Juego Godot/automatacelular.pck": 1017119,
                    "Juego Godot/automatacelular.wasm": 43610726
                },
                focusCanvas: false,
                gdextensionLibs: [],
                width: 1152,
                height: 648
            };

            let engineInstance;

            new Engine(GODOT_CONFIG).startGame().then((instance) => {
                console.log("Juego Godot iniciado y ejecutándose.");
                engineInstance = instance;
                if (engineInstance && engineInstance.setCanvasSize) {
                    engineInstance.setCanvasSize(canvas.clientWidth, canvas.clientHeight);
                }
            }).catch((err) => {
                console.error("Error al iniciar el juego Godot:", err);
                const gameContainer = document.getElementById('juego-container');
                gameContainer.innerHTML = '<p style="color: red; text-align: center;">Error al cargar el juego. Por favor, revisa la consola para más detalles.</p>';
            });

            // Inicialización de los récords reales
            fetchHighscores(); // Llama a la función que obtiene los récords de Netlify Functions

            // Asegúrate de que estos listeners aún son necesarios. Si Godot controla estos botones
            // o si ya no quieres la funcionalidad de "cargar más" en el frontend, puedes eliminarlos.
            // Para el top 10, no son estrictamente necesarios en el frontend puro.
            // Si los mantienes, la lógica de esos botones deberá ser re-implementada o eliminada si no se usa.
            if (cargarMasButton) {
                cargarMasButton.addEventListener('click', () => console.log('Botón "Cargar más" clickeado. Implementa la lógica si es necesario.'));
            }
            if (plegarListaButton) {
                plegarListaButton.addEventListener('click', () => console.log('Botón "Plegar lista" clickeado. Implementa la lógica si es necesario.'));
            }
        };
    </script>
</body>
</html>